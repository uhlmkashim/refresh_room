"use strict";
! function() {
    function t() {
        var t = new Object,
            e = 640;
        this.cloth_data = new Object, this.el = "#animation-container", this.$el = null, this.prefetch = null, this.loaded_action = null, this.swf_url_list = [], this.getCharacterLength = function() {
            return Object.keys(t).length
        }, this.getCharactersKeys = function() {
            return Object.keys(t)
        }, this.addCharacter = function(t, e) {
            if (!e) return !1;
            if (!t) var t = this.getCharacterLength();
            $.extend({}, e);
            return this.initCharacters(), !0
        }, this.pexInitialize = function() {
            for (var e in t) t[e].delPex()
        }, this.setCharacters = function(e) {
            if ("object" != typeof e) return !1;
            for (var i in e) {
                var n = $.extend({}, e[i]);
                t[i] = n
            }
            return this.initCharacters(), !0
        }, this.initCharacters = function() {
            this.init(t)
        }, this.initCharacter = function(e) {
            return !(!e || void 0 == t[e]) && ((new Object)[e] = t[e], !0)
        }, this.deleteCharacter = function(e) {
            return void 0 != t[e] && (void 0 != t[e].api && t[e].api, delete t[e], !0)
        }, this.setSwf = function(e, i) {
            return !(!e || !i) && (t[e].swf = i, !0)
        }, this.addCallAction = function(e, i) {
            return !(!e || !t[e] || "function" != typeof i) && (t[e].callaction = i, !0)
        }, this.deleteCallAction = function(e) {
            return !(!e || !t[e]) && (delete t[e].callaction, t[e].callaction = null, !0)
        }, this.callPetitAction = function(e) {
            return !(!e || "function" != typeof t[e].callaction) && (t[e].callaction(t[e]), !0)
        }, this.setWidth = function(t) {
            return !!t && (e = t, !0)
        }, this.getWidth = function() {
            return e
        }, this.doAction = function(e, i, n) {
            if (!e || !t[e] || !t[e].api) return !1;
            t[e].api.setVariables("", i), t[e].api.callActions("", n)
        }, this.getBodyType = function(e) {
            return t[e].body_type
        }
    }

    function e(t, e) {
        this.pex = !1, this.api = !1, this.parent = e, this.position = t, this.shortpants = !1, this.callaction = null
    }
    var i = window.petitManager || new t,
        n = window.Pex;
    t.prototype.init = function(t) {
        if (!this.elementsInitialize()) return void console.error("don't have element");
        var i = [];
        for (var n in t) void 0 == t[n].position && ($.extend(t[n], new e(n, this)), "string" == typeof t[n].swf && -1 == $.inArray(t[n].swf, this.swf_url_list) && (this.swf_url_list.push(t[n].swf), i.push(t[n].swf)));
        if (0 == i.length) return void this.initReady(t);
        var a = [];
        for (var n in i) {
            var r = $.Deferred();
            a.push(r.promise()), this.preLoadSwf(i[n], n, r)
        }
        var o = this;
        $.when.apply($, a).then(function() {
            o.initReady(t)
        })
    }, t.prototype.preLoadSwf = function(t, e, i) {
        var a = "preload_" + e,
            r = document.createElement("div");
        $(r).attr("id", a).addClass("animation").css("display", "none"), this.setPrefetch(), this.prefetch.appendChild(r);
        var o = new n(t, a, null),
            s = o.getAPI();
        s.ready(function() {
            s.destroy(), i.resolve()
        })
    }, t.prototype.initReady = function(t) {
        this.pexInitialize(), this.clothMerge(t)
    }, t.prototype.elementsInitialize = function() {
        return this.$el || (this.$el = $(this.el)), !!this.$el.length && (this.$el.empty(), !0)
    }, t.prototype.setAspect = function() {
        var t = this.$el.children(".animation");
        this.$el.css({
            width: .5 * parseInt(t.css("width")),
            height: .5 * parseInt(t.css("height"))
        })
    }, t.prototype.clothMerge = function(t) {
        var e = new Object;
        for (var i in t) $.extend(e, t[i].image_url_list);
        this.loadClothData(e, t)
    }, t.prototype.loadClothData = function(t, e) {
        var i = this,
            n = [];
        for (var a in t) {
            var r = $.Deferred();
            n.push(r.promise()), void 0 === this.cloth_data[a] ? void 0 !== window[a] ? this.imageAlready(a, window[a], r) : this.loadImageJs(t[a], a, r) : r.resolve()
        }
        $.when.apply($, n).then(function() {
            $(i.prefetch).empty(), i.ready(e)
        })
    }, t.prototype.loadImageJs = function(t, e, i) {
        var n = this,
            a = document.createElement("script");
        a.onload = function() {
            n.imageAlready(e, window[e], i)
        }, a.src = t, document.getElementsByTagName("head")[0].appendChild(a)
    }, t.prototype.imageAlready = function(t, e, i) {
        var n = [];
        for (var a in e) {
            var r = $.Deferred();
            n.push(r), this.cloth_data[t] = new Array, this.imageToReplace(t, e[a], a, r)
        }
        $.when.apply($, n).then(function() {
            i.resolve()
        })
    }, t.prototype.imageToReplace = function(t, e, i, n) {
        var a = new Image,
            r = this;
        a.onload = function() {
            r.cloth_data[t].push({
                name: i,
                img: a
            }), n.resolve()
        }, a.src = e, this.setPrefetch(), this.prefetch.appendChild(a)
    }, t.prototype.setPrefetch = function() {
        if (!this.prefetch) {
            var t = document.createElement("div");
            t.id = "prefetch", document.getElementsByTagName("head")[0].appendChild(t), this.prefetch = t
        }
    }, t.prototype.ready = function(t) {
        var e = this,
            i = [];
        for (var n in t)
            if (void 0 != t[n].swf) {
                var a = $.Deferred();
                t[n].init(a), i.push(a.promise())
            }
        $.when.apply($, i).then(function() {
            "function" == typeof e.loaded_action && e.loaded_action()
        })
    }, e.prototype.isShortpants = function(t) {
        t.indexOf("costume") > -1 && (t.indexOf("shortpants") > -1 ? this.shortpants = !0 : this.shortpants = !1)
    }, e.prototype.init = function(t) {
        this.deffered = t;
        var e = new Array;
        for (var i in this.image_url_list) {
            this.isShortpants(this.image_url_list[i]);
            for (var n in this.parent.cloth_data[i]) {
                if (i.indexOf("costume") > -1) {
                    if ((2 == this.breast_size || 3 == this.breast_size) && "replace_breast_L" == this.parent.cloth_data[i][n].name) continue;
                    if ((1 == this.breast_size || 3 == this.breast_size) && "replace_breast_S" == this.parent.cloth_data[i][n].name) continue
                }
                if (i.indexOf("leg") > -1)
                    if (this.shortpants) {
                        if ("replace_item_foot_L_back" == this.parent.cloth_data[i][n].name) continue
                    } else if ("replace_item_foot_L_front" == this.parent.cloth_data[i][n].name) continue;
                e.push(this.parent.cloth_data[i][n])
            }
        }
        this.setOption(e, t)
    }, e.prototype.setOption = function(t, e) {
        var i = {
            enableButton: !1,
            partialDraw: window.getPexPartialDraw(),
            delayEval: !1,
            transparent: !0,
            touchEvent: !1,
            replace: t,
            operation: {
                lighter_tgt: "lighter"
            },
            width: this.parent.getWidth()
        };
        this.pexRun(i, e)
    }, e.prototype.pexRun = function(t, e) {
        var i = this,
            a = "animation_" + this.position,
            r = document.createElement("div");
        $(r).attr("id", a).addClass("animation"), this.parent.$el.append(r), this.pex = new n(this.swf, a, t), this.api = this.pex.getAPI(), this.api.ready(function() {
            var t = {
                small_character_flg: 2 == i.body_type ? 1 : 0,
                big_character_flg: 4 == i.body_type ? 1 : 0,
                cheek_type: 3 == i.body_type ? 2 : 1,
                chara_num: i.parent.getCharacterLength(),
                chara_order: i.position
            };
            i.api.setVariables("/", t), "function" == typeof i.callaction && i.callaction(i), e.resolve()
        })
    }, e.prototype.delPex = function() {
        this.api && (this.api.destroy(), this.api = !1, this.pex = !1)
    }, window.petitManager = i
}();
